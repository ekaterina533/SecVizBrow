{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row">

    <!-- Левая панель -->
    <aside class="col-md-3 sidebar">
      <!-- Поиск и фильтры -->
      <div class="mb-4">
        <!-- Поиск -->
        <form class="d-flex mb-3" method="GET" action="{{ url_for('main.index') }}">
          <input class="form-control me-2" type="search" name="q" placeholder="Поиск..." value="{{ search_query }}">
          <button class="btn btn-outline-primary" type="submit"><i class="bi bi-search"></i></button>
          {% for tag in selected_tags %}
            <input type="hidden" name="tags" value="{{ tag }}">
          {% endfor %}
        </form>

        <!-- Фильтры по тегам -->
        <h5 class="mb-2">Фильтры по тегам</h5>
        <form method="GET">
          <div class="accordion" id="tagAccordion">
            {% for category in categories %}
            <div class="accordion-item mb-2 border-0 shadow-sm rounded">
              <h2 class="accordion-header" id="heading{{ category.id }}">
                <button class="accordion-button collapsed" type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#collapse{{ category.id }}">
                  {{ category.name }}
                </button>
              </h2>
              <div id="collapse{{ category.id }}" class="accordion-collapse collapse"
                  data-bs-parent="#tagAccordion">
                <div class="accordion-body">
                  {% for tag in category.tags %}
                  <div class="form-check mb-1">
                    <input class="form-check-input" type="checkbox" name="tags"
                          value="{{ tag.name }}" id="tag{{ tag.id }}"
                          {% if tag.name in selected_tags %}checked{% endif %}>
                    <label class="form-check-label" for="tag{{ tag.id }}">{{ tag.name }}</label>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <button type="submit" class="btn btn-primary mt-3 w-100">Применить</button>
          <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary mt-2 w-100">Сбросить</a>
        </form>
      </div>


      <div class="bg-light p-3 border mt-4">
        <h5 class="mb-2">Статистика</h5>
        <p class="mb-1">Загружено статей: <strong>{{ total_articles }}</strong></p>
        <p class="mb-0">Последнее обновление: <strong>{{ last_updated.strftime('%d.%m.%Y') if last_updated else '—' }}</strong></p>
      </div>
    </aside>
    <!-- Основной контент -->
    <main class="col-md-9">
      <div class="grid-container">
        {% for article in articles.items %}
        <div class="grid-item p-1">
          <img src="{{ url_for('static', filename='uploads/' ~ article.image) }}"
              class="viz-img"
              alt="{{ article.title }}"
              data-bs-toggle="modal"
              data-bs-target="#articleModal{{ article.id }}">
        </div>

        <!-- Модальное окно -->
        <div class="modal fade custom-modal" id="articleModal{{ article.id }}" tabindex="-1" aria-labelledby="modalLabel{{ article.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content border-0 shadow-lg rounded-4">
              <div class="modal-header border-0 pb-0">
                <div>
                  <h5 class="modal-title fw-bold" id="modalLabel{{ article.id }}">{{ article.title }}</h5>
                  {% if article.tags %}
                  <div class="mt-2">
                    {% for tag in article.tags %}
                    <span class="badge rounded-pill bg-warning text-dark me-1">{{ tag.name }}</span>
                    {% endfor %}
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="modal-body">
                <div class="row">
                  {% if article.image %}
                  <div class="col-md-4 mb-3">
                    <img src="{{ url_for('static', filename='uploads/' ~ article.image) }}" class="img-fluid rounded-3 shadow-sm" alt="Preview">
                  </div>
                  {% endif %}
                  <div class="col-md-8">
                    <p class="mb-2"><strong>Аннотация:</strong></p>
                    <p class="small text-muted">{{ article.abstract or "Аннотация не указана." }}</p>
                    <hr>
                    <p class="mb-1"><strong>Авторы:</strong> {{ article.authors }}</p>
                    <p class="mb-1"><strong>Журнал:</strong> {{ article.journal or "—" }}</p>
                    <p class="mb-1"><strong>Год:</strong> {{ article.year or "—" }}</p>
                    {% if article.doi %}
                    <p class="mb-1"><strong>DOI:</strong> <a href="https://doi.org/{{ article.doi }}" target="_blank">{{ article.doi }}</a></p>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="modal-footer border-0 pt-0">
                <a href="{{ url_for('main.download_bib', article_id=article.id) }}" class="btn btn-primary">
                  <i class="bi bi-download me-1"></i> BibTeX
                </a>
                {% if article.url %}
                <a href="{{ article.url }}" class="btn btn-outline-success" target="_blank">
                  <i class="bi bi-box-arrow-up-right me-1"></i> Читать
                </a>
                {% endif %}
                <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Закрыть</button>
                <button class="btn btn-secondary prev-modal" data-current-id="{{ article.id }}">←</button>
                <button class="btn btn-secondary next-modal" data-current-id="{{ article.id }}">→</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Пагинация -->
      <nav class="mt-4" aria-label="Навигация">
        <ul class="pagination justify-content-center">
          {% if articles.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.index', page=articles.prev_num, tags=request.args.getlist('tags')) }}">←</a>
          </li>
          {% endif %}
          {% for page_num in articles.iter_pages() %}
          {% if page_num %}
          <li class="page-item {% if page_num == articles.page %}active{% endif %}">
            <a class="page-link" href="{{ url_for('main.index', page=page_num, tags=request.args.getlist('tags')) }}">{{ page_num }}</a>
          </li>
          {% endif %}
          {% endfor %}
          {% if articles.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('main.index', page=articles.next_num, tags=request.args.getlist('tags')) }}">→</a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </main>
  </div>
</div>
{% endblock %}
